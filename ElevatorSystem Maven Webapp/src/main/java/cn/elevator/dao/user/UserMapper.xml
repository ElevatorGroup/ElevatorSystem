<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.elevator.dao.user.UserMapper">
<!-- 根据用户返回整个用户对象 -->
	<select id="login" resultType="User">
		select  u.id,u.userRole,u.companyId,u.deleted,u.realName,u.tel,u.userName,u.wenXin,
		u.password,u.buildingID,u.elevatorID,u.creater,u.createDate,u.updater,u.updatDate, 
		(select d.valueName  from dictionary d where d.typeCode="user_role" and d.valueId=u.userRole) as userRoleName
		from user u where userName = #{userName}
	</select>
	
	
	
	
	
	
	
	
	<resultMap type="User" id="getElevatorByUserRole">
		<id property="id" column="id"/>
		
		<result property="userRole" column="userRole"/>
		<result property="companyId" column="companyId"/>
		<result property="realName" column="realName"/>
		<result property="tel" column="tel"/>
		<result property="userName" column="userName"/>
		<result property="wenXin" column="wenXin"/>
		<result property="buildingID" column="buildingID"/>
		<result property="elevatorID" column="elevatorID"/>
		<collection property="elevatorList" ofType="ElevatorInfo">
			<id property="id" column="e_id"></id>
			<result property="buildingId" column="buildingId"/>
			<result property="elevatorModel" column="elevatorModel"/>
			<result property="elevatorNumber" column="elevatorNumber"/>
			<result property="internalNumber" column="internalNumber"/>
			<result property="elevatorType" column="elevatorType"/>
			<result property="usingState" column="usingState"/>
			<result property="firstMaintenance" column="firstMaintenance"/>
			<result property="maintenanceId" column="maintenanceId"/>
			<result property="maintenancePersonId" column="maintenancePersonId"/>
			<result property="elevatorCode" column="elevatorCode"/>
			<result property="registrationCode" column="registrationCode"/>
			<result property="factoryNumber" column="factoryNumber"/>
			<result property="usingNumber" column="usingNumber"/>
			<result property="registrationStatus" column="registrationStatus"/>
			<result property="proactivelyDate" column="proactivelyDate"/>
			<result property="projectId" column="projectId"/>
			
		</collection>
	
	</resultMap>
	
	
	
	<select id="getElevatorInfoList" resultMap="getElevatorByUserRole" >
		<!-- 0 质监局-->
		<if test="userRole==0">
		SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id, e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE userRole=#{userRole} and u.id=#{id}
		
		</if>
		
		
		<!-- 1 楼盘用户 -->
		<if test="userRole==1">
		select  u.id,u.userName,u.userRole,u.password,e.id as e_id, e.*,(select companyName
		from building where id=e.buildingId) as buildingName from user u,elevatorinfo e where 
		u.companyId=e.buildingId and u.userRole=#{userRole} and u.id=#{id}
		</if>
		
		
		
		<!-- 2 物业管理员 -->
		<if test="userRole==2">
		SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id, e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.buildingId IN (SELECT company_Jid FROM contract WHERE contractType=2 AND company_Yid=u.companyId) AND userRole=#{userRole} and u.id=#{id}
		</if>
		
		
		
		<!-- 3 物业员工 -->
		<if test="userRole==3">
		SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.buildingId=u.buildingId AND u.userRole=#{userRole} and u.id=#{id}
		</if>
		
		
		<!-- 4 维保管理员 -->
		<if test="userRole==4">
		SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		 u.companyId=e.maintenanceId AND u.userRole=#{userRole} and u.id=#{id}
		</if>
		
		
		<!-- 5 维保普通员工 -->
		<if test="userRole==5">
		SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.maintenancePersonId=u.id AND u.userRole=#{userRole} and u.id=#{id} 
		</if>
		
		
		<!-- 模糊查询的8个条件参数+2个分页参数 =10参数-->
		
		<if test="buildingId != null">
			and buildingId = #{buildingId}
		</if>
		<if test="Company_YId != null">
			and Company_YId = #{Company_YId}
		</if>
		<if test="maintenanceId != null">
			and maintenanceId = #{maintenanceId}
		</if>
		<if test="elevatorType != null">
			and elevatorType = #{elevatorType}
		</if>
		<if test="elevatorCode != null and elevatorCode != ''">
			and elevatorCode like CONCAT ('%',#{elevatorCode},'%')
		</if>
		<if test="registrationCode != null and registrationCode!= ''">
			and registrationCode like CONCAT
			('%',#{registrationCode},'%')
		</if>
		<if test="registrationStatus != null">
			and registrationStatus = #{registrationStatus}
		</if>
		<if test="usingState != null">
			and usingState = #{usingState}
		</if>

		ORDER BY e.id ASC LIMIT #{from},#{pageSize}
		
	</select>
	
	
	
	<!-- 质检局电梯条数 -->
	<select id="getCountBy0" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,(SELECT companyName
		FROM building b WHERE b.id=e.buildingId) AS buildingName FROM USER u,elevatorinfo e WHERE userRole=#{userRole} AND u.id=#{id}) AS a
	</select>
	
	<!-- 楼盘电梯条数 -->
	<select id="getCountBy1" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,(SELECT companyName
		FROM building b WHERE b.id=e.buildingId) AS buildingName FROM USER u,elevatorinfo e WHERE userRole=#{userRole} AND u.id=#{id}) AS a
	</select>
	
	<!-- 物业管理员电梯条数 -->
	<select id="getCountBy2" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.buildingId IN (SELECT company_Jid FROM contract WHERE contractType=2 AND company_Yid=u.companyId) AND userRole=#{userRole} and u.id=#{id}) AS a
	</select>
	
	<!-- 物业普通员工电梯条数 -->
	<select id="getCountBy3" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.buildingId=u.buildingId AND u.userRole=#{userRole} and u.id=#{id}) AS a
	</select>
	
	<!-- 维保管理电梯条数 -->
	<select id="getCountBy4" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		 u.companyId=e.maintenanceId AND u.userRole=#{userRole} and u.id=#{id}) AS a
	</select>
	
	<!-- 维保普通用户电梯条数 -->
	<select id="getCountBy5" resultType="Integer" parameterType="Integer">
		SELECT COUNT(1) FROM (SELECT  u.id,u.userName,u.userRole,u.password,e.id AS e_id,e.*,(select companyName
		from building where id=e.buildingId) as buildingName FROM USER u,elevatorinfo e WHERE 
		e.maintenancePersonId=u.id AND u.userRole=#{userRole} and u.id=#{id}) AS a
	</select>
	
	
	

</mapper>